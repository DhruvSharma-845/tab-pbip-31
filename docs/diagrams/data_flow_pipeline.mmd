%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4A90A4'}}}%%
flowchart LR
    subgraph PHASE1["Phase 1: INGESTION"]
        direction TB
        A1["Unzip TWBX"]
        A2["Extract TWB XML"]
        A3["Load Data Extracts<br/>.hyper / .tde"]
        A4["Load Snapshots<br/>PNG / SVG"]
        A1 --> A2
        A2 --> A3
        A1 --> A4
    end

    subgraph PHASE2["Phase 2: PARSING"]
        direction TB
        B1["Parse TWB XML"]
        B2["Extract Datasources"]
        B3["Extract Calculations"]
        B4["Extract Worksheets"]
        B5["Analyze Snapshots"]
        B6["Detect Chart Types"]
        B7["Extract Layout"]
        B1 --> B2 --> B3 --> B4
        B5 --> B6 --> B7
    end

    subgraph PHASE3["Phase 3: TRANSFORMATION"]
        direction TB
        C1["Map Columns → TMDL"]
        C2["Convert Calcs → DAX"]
        C3["Build Relationships"]
        C4["Map Worksheets → Visuals"]
        C5["Position from Snapshots"]
        C6["Apply Styling"]
        C1 --> C2 --> C3
        C4 --> C5 --> C6
    end

    subgraph PHASE4["Phase 4: GENERATION"]
        direction TB
        D1["Generate TMDL Files"]
        D2["Generate Visual JSONs"]
        D3["Generate Page JSONs"]
        D4["Validate Schema"]
        D5["Write PBIP Folder"]
        D1 --> D4
        D2 --> D4
        D3 --> D4
        D4 --> D5
    end

    PHASE1 --> PHASE2 --> PHASE3 --> PHASE4

    classDef phase1 fill:#BBDEFB,stroke:#1976D2,stroke-width:2px
    classDef phase2 fill:#C8E6C9,stroke:#388E3C,stroke-width:2px
    classDef phase3 fill:#FFE0B2,stroke:#F57C00,stroke-width:2px
    classDef phase4 fill:#E1BEE7,stroke:#7B1FA2,stroke-width:2px

    class A1,A2,A3,A4 phase1
    class B1,B2,B3,B4,B5,B6,B7 phase2
    class C1,C2,C3,C4,C5,C6 phase3
    class D1,D2,D3,D4,D5 phase4
